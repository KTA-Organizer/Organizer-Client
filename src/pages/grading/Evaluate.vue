<template>
    <div>
        <v-layout row justify-center>
            <v-dialog v-model="popup" persistent max-width="290">
                <v-card>
                    <v-card-title class="headline">Evaluatie verwijderen?</v-card-title>
                    <v-card-text>Zeker dat u {{popupName}} wilt verwijderen? <br/> <span style="color: red">(Dit kan niet ongedaan gemaakt worden)</span></v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn color="green darken-1" flat @click.native="popup = false">NEE</v-btn>
                        <v-btn color="green darken-1" flat @click.native="deleteEval(popupId)">JA</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>
        </v-layout>
        <v-layout row wrap>
            <v-flex xs12 offset-xs1 class="text-xs-left">
                <h1 class="display-3">Evaluatie</h1>
            </v-flex>
        </v-layout>
        <v-layout row-wrap>
            <v-flex xs12 offset-xs1 class="text-xs-left">
                <h2 class="headline">Evaluatiefiche voor: {{ student.firstname }} {{student.name}}</h2>
            </v-flex>
        </v-layout>
        <v-layout row-wrap>
            <v-flex xs4 class="text-xs-left">
                <v-breadcrumbs>
                    <v-breadcrumbs-item
                            v-for="breadcrumb in breadcrumbs" :key="breadcrumb.id" :disabled="breadcrumb.disabled"
                    >
                        {{ breadcrumb.text }}
                    </v-breadcrumbs-item>
                </v-breadcrumbs>
            </v-flex>
        </v-layout>
        <v-layout row-wrap>
            <v-flex xs12 sm4 offset-xs1>
                <v-select
                        label="Selecteer een module"
                        v-bind:items="modulesDropdown"
                        v-model="selectedModuleName"
                        persistent-hint
                        @input="selectItem()"
                ></v-select>
            </v-flex>
        </v-layout>
        <v-layout v-if="moduleSelected" row wrap class="text-xs-left">
            <v-flex offset-xs1>
                <div>
                    <v-btn v-if="!newEvalTable" @click="newEval" color="primary"><v-icon class="mr-2">add</v-icon>Nieuwe Evaluatiefiche</v-btn>
                    <v-btn v-if="newEvalTable" @click="newEvalTable = false; updateEval = true" color="primary"><v-icon class="mr-2">undo</v-icon>Back</v-btn>
                    <v-btn v-if="newEvalTable && !updateEval" @click="makeJSON(false)" color="primary"><v-icon class="mr-2">save</v-icon>Evaluatie Opslaan</v-btn>
                    <v-btn v-if="newEvalTable && updateEval" @click="makeJSON(true)" color="primary"><v-icon class="mr-2">save</v-icon>Evaluatie Opslaan</v-btn>
                    <p v-if="evalError" style="display: inline-block" class="red--text">{{evalError}}</p>
                </div>
            </v-flex>
        </v-layout>
        <v-flex xs10 offset-xs1>
            <v-list two-line v-if="moduleSelected && !newEvalTable && gotEvals">
                <v-subheader>{{'Evaluaties van ' + student.firstname + ' ' + student.name}}</v-subheader>
                <template v-for="evaluation in prevEvals[0].evaluaties.slice().reverse()">
                    <v-divider
                    :key="evaluation.id"
                    ></v-divider>
                    <v-list-tile v-bind:key="evaluation.id" @click="getEvaluation(evaluation.id)">
                        <v-list-tile-content>
                            <v-list-tile-title>{{evaluation.date}} {{evaluation.name}} </v-list-tile-title>
                        </v-list-tile-content>
                        <v-btn color="error" v-on:click.stop="deleteEvalPopup(evaluation.id, evaluation.name)" class="right" dark><v-icon dark>delete</v-icon></v-btn>
                    </v-list-tile>
                </template>
            </v-list>
        </v-flex>
        <template v-if="newEvalTable">
        <v-flex xs8 offset-xs2>
            <v-layout row-wrap>
                <v-flex>
                    <v-layout row-wrap>
                        <v-flex>
                            <v-card color="gray darken-3" class="black--text text-xs-left" height="100%">
                                <v-container fluid grid-list-lg>
                                    <v-flex>
                                        <v-text-field
                                                name="EvalFicheName"
                                                label="Naam evaluatiefiche"
                                                v-model="evalName"
                                        ></v-text-field>
                                    </v-flex>
                                </v-container>
                            </v-card>
                        </v-flex>
                        <v-flex>
                            <v-layout row-wrap>
                                <v-flex>
                                    <v-card color="gray darken-3" class="black--text text-xs-left" height="100%">
                                        <v-container fluid grid-list-lg>
                                            <v-layout row wrap>
                                                <v-flex xs3>
                                                    <p class="left">Datum:</p>
                                                    <datepicker class="datepicker1" :value=date :format="format"></datepicker>
                                                </v-flex>
                                            </v-layout>
                                        </v-container>
                                    </v-card>
                                </v-flex>
                            </v-layout>
                            <v-layout row-wrap>
                                <v-flex>
                                    <v-card color="gray darken-3" class="black--text text-xs-left" height="100%">
                                        <v-container style="text-align: right;" fluid grid-list-lg>
                                            <p>Evaluatie leerkracht</p>
                                            <p><span>JA</span> | <span>NEE</span></p>
                                        </v-container>
                                    </v-card>
                                </v-flex>
                            </v-layout>
                        </v-flex>
                    </v-layout>
                </v-flex>
            </v-layout>
            <v-layout v-for="(cat, i) in selectedModule[0].categorieen" :key="i">
                <v-layout row-wrap class="mb-1">
                    <v-flex>
                        <v-layout row-wrap>
                            <v-flex>
                                <v-card class="black--text text-xs-center display-1" height="100%">
                                    <v-container>
                                        {{i+1}} {{cat.name}}
                                    </v-container>
                                </v-card>
                            </v-flex>
                        </v-layout>
                        <v-layout row-wrap>
                            <v-flex xs12>
                                <v-layout row-wrap v-for="(doel, j) in cat.doelstellingen" :key="j">
                                    <v-flex xs3>
                                        <v-card class="black--text text-xs-left" height="100%">
                                            <v-container fluid grid-list-lg>
                                                {{i+1}}.{{j+1}} {{doel.name}}
                                            </v-container>
                                        </v-card>
                                    </v-flex>
                                    <v-flex xs9>
                                        <v-layout row-wrap v-for="(crit, k) in doel.criteria" :key="k">
                                            <v-flex xs4>
                                                <v-card class="black--text text-xs-left" height="100%">
                                                    <v-container fluid grid-list-lg>
                                                        {{i+1}}.{{j+1}}.{{k+1}} {{crit.name}}
                                                    </v-container>
                                                </v-card>
                                            </v-flex>
                                            <v-flex xs8>
                                                <v-layout row-wrap v-for="(aspect, l) in crit.aspecten" :key="l">
                                                    <v-flex xs6>
                                                        <v-card color="gray darken-3" class="black--text text-xs-left" height="100%">
                                                            <v-container fluid grid-list-lg>
                                                                {{i+1}}.{{j+1}}.{{k+1}}.{{l+1}} {{aspect.name}}
                                                            </v-container>
                                                        </v-card>
                                                    </v-flex>
                                                    <v-flex xs2>
                                                        <v-btn
                                                                class="evalCard black--text text-xs-left"
                                                                style="height: 100%;margin: 0;"
                                                                v-if="activeBoxesCreated"
                                                                v-on:click="logYes(aspect.id)"
                                                                :class="{green: activeBoxes['yes' + aspect.id]}"
                                                        >
                                                            <p>JA</p>
                                                        </v-btn>
                                                    </v-flex>
                                                    <v-flex xs2>
                                                        <v-btn
                                                                class="evalCard black--text text-xs-left"
                                                                style="height: 100%; margin: 0"
                                                                v-if="activeBoxesCreated"
                                                                v-on:click="logNo(aspect.id)"
                                                                :class="{red: activeBoxes['no' + aspect.id]}"
                                                        >
                                                            <p>NEE</p>
                                                        </v-btn>
                                                    </v-flex>
                                                    <v-flex xs2>
                                                        <v-btn
                                                                class="evalCard black--text text-xs-left"
                                                                style="height: 100%; margin: 0"
                                                                v-if="activeBoxesCreated"
                                                                v-on:click="reset(aspect.id)"
                                                        >
                                                            <p>Reset</p>
                                                        </v-btn>
                                                    </v-flex>
                                                </v-layout>
                                            </v-flex>
                                        </v-layout>
                                    </v-flex>
                                </v-layout>
                            </v-flex>
                        </v-layout>
                    </v-flex>
                </v-layout>
            </v-layout>
        </v-flex>
       </template>
    </div>
</template>

<script>
export default {
  name: "Evaluatie",
  data() {
    return {
      student: {},
      breadcrumbs: [
        { id: 0, text: "test", disabled: false },
        { id: 1, text: "", disabled: false }
      ],
      modulesDropdown: [],
      modules: [],
      selectedModuleName: [],
      selectedModule: {},
      evalFiches: [],
      prevEvals: [],
      moduleSelected: false,
      newEvalTable: false,
      gotEvals: false,
      updateEval: false,
      doelRowSpan: 0,
      activeBoxes: {},
      activeBoxesCreated: false,
      saveEval: {},
      evalName: "",
      currentEvalId: null,
      evalError: null,
      format: "dd/MM/yyyy",
      date: null,
      menu: false,
      popup: false,
      popupId: null,
      popupName: null
    };
  },
  methods: {
    selectItem: function() {
      var self = this;
      this.breadcrumbs[1].text = this.selectedModuleName;
      var result = this.modules.filter(function(obj) {
        return obj.name === self.selectedModuleName;
      });
      this.selectedModule = result;
      console.log(this.selectedModule);
      this.moduleSelected = true;
      this.newEvalTable = false;
      self.createActiveBoxes(this.selectedModule);
      self.getPrevEvals();
    },
    getPrevEvals: function() {
      var self = this;
      self.prevEvals = [];
      this.$http.getEvalsByStudent(
        this.selectedModule[0].id,
        this.student.id,
        function(data) {
          self.prevEvals.push(data);
          // console.log(self.prevEvals)
          self.gotEvals = true;
        }
      );
    },
    newEval: function() {
      var self = this;
      self.newEvalTable = true;
      var d = new Date();
      var month = d.getMonth() + 1;
      self.date = month + "/" + d.getDate() + "/" + d.getFullYear();
      self.evalName = null;
      self.createActiveBoxes(this.selectedModule);
      self.updateEval = false;
    },
    createActiveBoxes: function(module) {
      this.activeBoxes = {};
      for (var i = 0; i < module.length; i++) {
        for (var j = 0; j < module[i].categorieen.length; j++) {
          for (
            var k = 0;
            k < module[i].categorieen[j].doelstellingen.length;
            k++
          ) {
            for (
              var l = 0;
              l < module[i].categorieen[j].doelstellingen[k].criteria.length;
              l++
            ) {
              for (
                var m = 0;
                m <
                module[i].categorieen[j].doelstellingen[k].criteria[l].aspecten
                  .length;
                m++
              ) {
                var objectid =
                  module[i].categorieen[j].doelstellingen[k].criteria[l]
                    .aspecten[m].id;
                var objectName = "yes" + objectid;
                this.activeBoxes[objectName] = null;
                objectName = "no" + objectid;
                this.activeBoxes[objectName] = null;
              }
            }
          }
        }
      }
      this.activeBoxesCreated = true;
    },
    logYes: function(id) {
      this.$set(this.activeBoxes, "yes" + id, 1);
      this.$set(this.activeBoxes, "no" + id, 0);
      this.$forceUpdate();
    },
    logNo: function(id) {
      this.$set(this.activeBoxes, "yes" + id, 0);
      this.$set(this.activeBoxes, "no" + id, 1);
      this.$forceUpdate();
    },
    reset: function(id) {
      this.$set(this.activeBoxes, "yes" + id, null);
      this.$set(this.activeBoxes, "no" + id, null);
      this.$forceUpdate();
    },
    makeJSON: function(update) {
      var self = this;
      if (this.evalName !== "") {
        this.evalError = null;
        var objKeys = Object.keys(this.activeBoxes);
        var objLength = Object.keys(this.activeBoxes).length;
        this.saveEval["name"] = this.evalName;
        this.saveEval["studentId"] = this.student.id;
        this.saveEval["moduleId"] = this.selectedModule[0].id;
        this.saveEval["aspecten"] = [];
        this.saveEval["date"] = document.querySelector(
          ".datepicker1 input"
        ).value;
        for (var i = 0; i < objLength; i = i + 2) {
          var obj = {
            aspectId: objKeys[i].substr(3),
            beoordeling: this.activeBoxes[objKeys[i]]
          };
          this.saveEval["aspecten"].push(obj);
        }
        if (update) {
          this.saveEval["evalId"] = this.currentEvalId;
          this.$http.updateEval(this.saveEval, function(data) {
            self.getPrevEvals();
          });
        } else {
          this.$http.createEval(this.saveEval, function(data) {
            self.getPrevEvals();
          });
        }
        console.log(this.saveEval);
        this.newEvalTable = false;
      } else {
        this.evalError = "geef een naam op voor de Evaluatiefiche";
      }
    },
    getEvaluation: function(id) {
      var self = this;
      self.newEvalTable = true;
      var obj = self.prevEvals[0].evaluaties.filter(function(elem) {
        if (elem.id === id) return elem;
      });
      self.evalName = obj[0].name;
      var d = obj[0].date.split("/");
      var d1 = d[2] + "/" + d[1] + "/" + d[0];
      self.date = d1;
      self.currentEvalId = obj[0].id;
      self.createActiveBoxes(this.selectedModule);
      obj[0].aspecten.forEach(function(item) {
        if (item.aspectBeoordeling === "1") {
          self.$set(self.activeBoxes, "yes" + item.aspectId, 1);
          self.$set(self.activeBoxes, "no" + item.aspectId, 0);
        } else if (item.aspectBeoordeling === "0") {
          self.$set(self.activeBoxes, "yes" + item.aspectId, 0);
          self.$set(self.activeBoxes, "no" + item.aspectId, 1);
        }
      });
      self.updateEval = true;
      this.$forceUpdate();
    },
    deleteEvalPopup: function(id, name) {
      this.popupId = id;
      this.popupName = name;
      this.popup = true;
    },
    deleteEval: function(id) {
      this.popup = false;
      var self = this;
      console.log(id);
      this.$http.deleteEval(id, function(data) {
        console.log(data);
        self.getPrevEvals();
      });
    }
  },
  async created() {
    var self = this;
    const studentId = this.$route.query.id;
    const student = await this.$http.getUser(studentId);
    this.student = student;
    console.log("studentje", this.student);
    const opleidingObj = await this.$http.getStudentOpleiding(this.student.id);
    this.breadcrumbs[0].text = opleidingObj.opleiding.name;
    console.log(this.student.id);
    const evaluations = await this.$http.getEvalsByStudent(this.student.id);
    this.modules = await this.$http.getModulesForStudent(this.student.id);
    this.modules.forEach(x => this.modulesDropdown.push(x.name));
  }
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
p {
  margin-bottom: 0;
}
input[type="radio"] {
  display: inline-block;
  position: absolute;
  left: 33%;
  top: 50%;
  transform: translateY(-50%) scale(3);
}
</style>
